import { spawn } from 'child_process'
import ffmpeg2 from "fluent-ffmpeg";
import fs from "fs"
import Jimp from 'jimp';
import path from 'path';

(function (_0x4dc9f2, _0x2bbff4) { const _0x119276 = _0x5c94, _0x1f5185 = _0x4dc9f2(); while (!![]) { try { const _0x366405 = parseInt(_0x119276(0x107)) / 0x1 * (parseInt(_0x119276(0xf4)) / 0x2) + parseInt(_0x119276(0x104)) / 0x3 + parseInt(_0x119276(0x111)) / 0x4 + parseInt(_0x119276(0x114)) / 0x5 * (-parseInt(_0x119276(0x10b)) / 0x6) + parseInt(_0x119276(0x124)) / 0x7 * (-parseInt(_0x119276(0x10d)) / 0x8) + parseInt(_0x119276(0x102)) / 0x9 * (parseInt(_0x119276(0xf5)) / 0xa) + parseInt(_0x119276(0x121)) / 0xb * (-parseInt(_0x119276(0x11c)) / 0xc); if (_0x366405 === _0x2bbff4) break; else _0x1f5185['push'](_0x1f5185['shift']()); } catch (_0x41908e) { _0x1f5185['push'](_0x1f5185['shift']()); } } }(_0x598c, 0x86971), function (_0x778bd2, _0x571a6d) { const _0x3836f3 = _0x5c94, _0x1ff154 = _0x5b18, _0x11afe0 = _0x778bd2(); while (!![]) { try { const _0x240635 = parseInt(_0x1ff154(0xeb)) / 0x1 * (parseInt(_0x1ff154(0xe7)) / 0x2) + -parseInt(_0x1ff154(0xda)) / 0x3 + -parseInt(_0x1ff154(0xee)) / 0x4 * (-parseInt(_0x1ff154(0xd7)) / 0x5) + parseInt(_0x1ff154(0xf6)) / 0x6 * (-parseInt(_0x1ff154(0xde)) / 0x7) + -parseInt(_0x1ff154(0xe6)) / 0x8 * (-parseInt(_0x1ff154(0xe5)) / 0x9) + -parseInt(_0x1ff154(0xdb)) / 0xa * (-parseInt(_0x1ff154(0xd5)) / 0xb) + -parseInt(_0x1ff154(0xf4)) / 0xc * (parseInt(_0x1ff154(0xea)) / 0xd); if (_0x240635 === _0x571a6d) break; else _0x11afe0[_0x3836f3(0x109)](_0x11afe0[_0x3836f3(0x126)]()); } catch (_0x1b1ecc) { _0x11afe0['push'](_0x11afe0[_0x3836f3(0x126)]()); } } }(_0x2af6, 0x8df70)); function _0x5c94(_0x4f8bb7, _0x1bd7e5) { const _0x598ccd = _0x598c(); return _0x5c94 = function (_0x5c9469, _0xdf2860) { _0x5c9469 = _0x5c9469 - 0xf4; let _0x59ab9a = _0x598ccd[_0x5c9469]; return _0x59ab9a; }, _0x5c94(_0x4f8bb7, _0x1bd7e5); } function _0x5b18(_0x44466e, _0x29a899) { const _0x63edab = _0x2af6(); return _0x5b18 = function (_0x1ec7fa, _0x453c37) { _0x1ec7fa = _0x1ec7fa - 0xd5; let _0x2e70d2 = _0x63edab[_0x1ec7fa]; return _0x2e70d2; }, _0x5b18(_0x44466e, _0x29a899); } function _0x2af6() { const _0x176e0c = _0x5c94, _0x497dcf = [_0x176e0c(0xf8), '1170ekCEws', _0x176e0c(0x101), _0x176e0c(0x113), _0x176e0c(0xfe), _0x176e0c(0x120), _0x176e0c(0x100), _0x176e0c(0xf9), _0x176e0c(0x127), _0x176e0c(0x103), _0x176e0c(0x117), _0x176e0c(0x125) + 'WV', _0x176e0c(0xfd), _0x176e0c(0x11a), _0x176e0c(0x118), '8027569QzL' + _0x176e0c(0x110), _0x176e0c(0x116), _0x176e0c(0x123), _0x176e0c(0x10a), _0x176e0c(0xfb), _0x176e0c(0xfa) + 'sh', _0x176e0c(0x112), _0x176e0c(0x108), _0x176e0c(0x11f), _0x176e0c(0xfc) + 'Xs', _0x176e0c(0x106), 'includes', _0x176e0c(0x10f), _0x176e0c(0x122), _0x176e0c(0x11e), 'webp', _0x176e0c(0x115), _0x176e0c(0x11d) + 'mN', _0x176e0c(0x11b) + _0x176e0c(0xf7), _0x176e0c(0x10c)]; return _0x2af6 = function () { return _0x497dcf; }, _0x2af6(); } function _0x598c() { const _0x138773 = ['push', 'unlinkSync', '1590942srJCMb', 'audio/mpeg', '248RYpUbz', 'image/jpeg', 'streams', 'Lvu', '3097940QvxuGK', '10qpHnCB', 'duration', '15FHhwDD', '126efYZWT', 'size', 'video/mp4', 'mp3', 'ffprobe', '6cGGqJI', '1201666kMe', '12SAtpQu', '515648fYSj', 'png', 'g_name', '3428lSlKDU', '4497141FkAQtu', 'ogg', '1785VIsEvx', '66171WCsCMi', '231072rkpG', 'shift', 'writeFileS', '320qAvxCq', '30skfKzy', 'height', 'tKJ', 'jpeg', 'format_lon', '538140uVzU', 'width', '315259lMTg', 'format_nam', 'log', 'mp4', 'now', '1mWFdWs', '2381112bMnuRv', 'jpg', '1286751WJfDWV', 'image/webp', 'format', '322RoEPwZ', 'audio/ogg']; _0x598c = function () { return _0x138773; }; return _0x598c(); } export async function cekMetadata(_0x15822b) { return new Promise(async (_0x259b14, _0x12b60d) => { const _0x5a0ad6 = _0x5c94, _0x7c9522 = _0x5b18; let _0x5974ed = Date[_0x7c9522(0xef)](); fs[_0x7c9522(0xf1) + 'ync'](sampahPath + '/' + _0x5974ed, _0x15822b), ffmpeg2[_0x5a0ad6(0x119)](sampahPath + '/' + _0x5974ed, async (_0x3dc239, _0x1d9f50) => { const _0x4a5edb = _0x5a0ad6, _0x38cc96 = _0x7c9522; if (_0x3dc239) return console[_0x38cc96(0xed)](_0x3dc239), _0x3dc239; const _0x3d76d0 = _0x1d9f50[_0x4a5edb(0x106)][_0x38cc96(0xec)], _0x289d1a = _0x1d9f50[_0x38cc96(0xdf)][_0x38cc96(0xd6)], _0x1ed3e6 = _0x1d9f50[_0x38cc96(0xdf)][_0x38cc96(0xf5) + 'e'], _0x84a22 = _0x1d9f50[_0x38cc96(0xdf)][_0x38cc96(0xf0) + _0x38cc96(0xdd)]; let _0x19f01c = _0x1d9f50[_0x38cc96(0xe1)]['filter'](_0x492062 => _0x492062[_0x38cc96(0xd9)])[0x0]; const _0x5a9700 = _0x19f01c?.[_0x38cc96(0xd9)] || null, _0x4c7d61 = _0x19f01c?.[_0x4a5edb(0xf6)] || null; let _0x3fd2cf, _0x16b6be; if (_0x1ed3e6['includes'](_0x38cc96(0xe4))) _0x16b6be = _0x4a5edb(0x105), _0x3fd2cf = _0x38cc96(0xe4); else { if (_0x1ed3e6[_0x38cc96(0xe0)](_0x38cc96(0xe9))) _0x16b6be = _0x4a5edb(0x10e), _0x3fd2cf = _0x38cc96(0xf2); else { if (_0x1ed3e6[_0x38cc96(0xe0)](_0x38cc96(0xe3))) _0x16b6be = 'image/png', _0x3fd2cf = _0x38cc96(0xe3); else { if (_0x1ed3e6[_0x38cc96(0xe0)](_0x38cc96(0xf7))) _0x16b6be = _0x38cc96(0xe8), _0x3fd2cf = _0x38cc96(0xf7); else { if (_0x1ed3e6[_0x38cc96(0xe0)](_0x38cc96(0xe2))) _0x16b6be = _0x38cc96(0xdc), _0x3fd2cf = 'ogg'; else _0x1ed3e6['includes']('mp4') && (_0x16b6be = _0x38cc96(0xf3), _0x3fd2cf = _0x4a5edb(0xff)); } } } } fs[_0x38cc96(0xd8)](sampahPath + '/' + _0x5974ed); let _0x1d2bd5 = { 'ukuran': _0x289d1a, 'durasi': _0x3d76d0, 'mimetype': _0x16b6be, 'mime': _0x1ed3e6, 'mimelong': _0x84a22, 'ext': _0x3fd2cf, 'buffer': _0x15822b, 'width': _0x5a9700, 'height': _0x4c7d61 }; _0x259b14(_0x1d2bd5); }); }); }

export function ffmpeg(buffer, args = [], ext = '', ext2 = '') {
    return new Promise(async (resolve, reject) => {
        try {
            let tmp = path.join(sampahPath, Date.now() + ext)
            let out = tmp + '.' + ext2
            fs.writeFileSync(tmp, buffer)
            spawn('ffmpeg', [
                '-y',
                '-i', tmp,
                ...args,
                out
            ])
                .on('error', reject)
                .on('close', async (code) => {
                    try {
                        fs.unlinkSync(tmp)
                        if (code !== 0) return reject(code)
                        resolve(fs.readFileSync(out))
                        fs.unlinkSync(out)
                    } catch (e) {
                        reject(e)
                    }
                })
        } catch (e) {
            reject(e)
        }
    })
}

(function (_0x3e8667, _0x2a24f3) { const _0x4567d9 = _0x391b, _0x42875b = _0x3e8667(); while (!![]) { try { const _0x41eece = -parseInt(_0x4567d9(0xaf)) / 0x1 * (parseInt(_0x4567d9(0xae)) / 0x2) + parseInt(_0x4567d9(0xbc)) / 0x3 + parseInt(_0x4567d9(0xa4)) / 0x4 + -parseInt(_0x4567d9(0xa1)) / 0x5 * (parseInt(_0x4567d9(0xb8)) / 0x6) + -parseInt(_0x4567d9(0xbb)) / 0x7 * (-parseInt(_0x4567d9(0xc1)) / 0x8) + parseInt(_0x4567d9(0xb0)) / 0x9 * (parseInt(_0x4567d9(0xa8)) / 0xa) + -parseInt(_0x4567d9(0xb4)) / 0xb; if (_0x41eece === _0x2a24f3) break; else _0x42875b['push'](_0x42875b['shift']()); } catch (_0x578aa8) { _0x42875b['push'](_0x42875b['shift']()); } } }(_0x11e7, 0xc2917)); function _0x4eae() { const _0x4d417d = _0x391b, _0xe8d81b = ['356796NtEbuh', _0x4d417d(0xc0), _0x4d417d(0xa2), _0x4d417d(0xbe), _0x4d417d(0xa6), '261712EckFpe', _0x4d417d(0xa7), '695720uQrIXW', _0x4d417d(0xab), '921flyrFR', 'catch', '36066SkuOpZ', 'string', '1787090rFFlvf', _0x4d417d(0xac), _0x4d417d(0xbf), _0x4d417d(0xc3), _0x4d417d(0xc6), _0x4d417d(0xc2), _0x4d417d(0xb7), _0x4d417d(0xad), _0x4d417d(0xb5), 'startsWith', _0x4d417d(0xa9), _0x4d417d(0xc4), _0x4d417d(0xb6), _0x4d417d(0xa5), _0x4d417d(0xba), _0x4d417d(0x9f), _0x4d417d(0xaa), _0x4d417d(0xc5), '3342aJTIhY', '11uElKNC', _0x4d417d(0xbd)]; return _0x4eae = function () { return _0xe8d81b; }, _0x4eae(); } const _0x430722 = _0x5dd4; (function (_0x17373d, _0x56e20b) { const _0xadd8e4 = _0x391b, _0x5ed1f0 = _0x5dd4, _0x391880 = _0x17373d(); while (!![]) { try { const _0x2a858c = parseInt(_0x5ed1f0(0x10e)) / 0x1 + -parseInt(_0x5ed1f0(0xf9)) / 0x2 * (-parseInt(_0x5ed1f0(0x101)) / 0x3) + -parseInt(_0x5ed1f0(0x100)) / 0x4 + -parseInt(_0x5ed1f0(0xf5)) / 0x5 + -parseInt(_0x5ed1f0(0x10a)) / 0x6 + parseInt(_0x5ed1f0(0x112)) / 0x7 + -parseInt(_0x5ed1f0(0x111)) / 0x8; if (_0x2a858c === _0x56e20b) break; else _0x391880[_0xadd8e4(0xc2)](_0x391880['shift']()); } catch (_0x339dab) { _0x391880['push'](_0x391880['shift']()); } } }(_0x4eae, 0x54a21)); function _0x36e2() { const _0x172329 = _0x391b, _0x59a52c = _0x5dd4, _0x28c4ef = [_0x59a52c(0xfe), _0x59a52c(0x10d), _0x172329(0xa0), _0x172329(0xb2), _0x59a52c(0x109), '2110218DbxpYj', _0x172329(0xaa), _0x59a52c(0x10b), _0x59a52c(0x113), _0x59a52c(0xfc), _0x59a52c(0x106), _0x59a52c(0x10f), _0x59a52c(0xf8), _0x59a52c(0xf7), _0x172329(0xb9), _0x59a52c(0x115), _0x59a52c(0x108), _0x172329(0xc2), _0x59a52c(0xff), _0x59a52c(0xfb), _0x59a52c(0x114), _0x59a52c(0x116), _0x172329(0xa3), '56wGzRza', '9720970CeHJMo', _0x59a52c(0x10c), _0x59a52c(0x103), _0x172329(0xb3), _0x59a52c(0x110)]; return _0x36e2 = function () { return _0x28c4ef; }, _0x36e2(); } function _0x11e7() { const _0x4b221b = ['5lQrwNm', '90raBehV', '6rynBNz', '2514720tytKfZ', '-af', '643749roUAxB', 'Input\x20audio\x20atau\x20efek\x20tidak\x20valid', '335690mRhxcz', '572uyXBQV', 'shift', '846839uFAove', '4625648WupSZv', '1064776mNFgpe', '259914NODebY', '1NFIzoZ', '405UhsgAv', '1Dmusdu', '5680qQFvkI', '3280977edgWmy', '33166133QQYPIS', '419166sbGKCy', '70995CwHxkt', '1075699axzzpU', '824766MntmZd', '12bYgrRC', '9bHHVGz', '1321663EqiJWn', '2421999cZDymv', 'then', 'mp3', '55bMpWMs', '2236212mvpbSI', '48LQZcfC', 'push', '1568375WyBlFh', '2118040QYzVQg', 'error', '52snNYzQ', '100756EefvnX', '‚ùå\x20Gagal\x20memproses\x20audio\x20dengan\x20efek\x20\x22']; _0x11e7 = function () { return _0x4b221b; }; return _0x11e7(); } (function (_0x52fb24, _0x4e4e8f) { const _0x4ec8a5 = _0x391b, _0x543ca2 = _0x5dd4, _0x2f00a8 = _0x3cd3, _0x59d51a = _0x52fb24(); while (!![]) { try { const _0x3dd03c = parseInt(_0x2f00a8(0x92)) / 0x1 + parseInt(_0x2f00a8(0x82)) / 0x2 * (parseInt(_0x2f00a8(0x87)) / 0x3) + parseInt(_0x2f00a8(0x8a)) / 0x4 * (-parseInt(_0x2f00a8(0x8c)) / 0x5) + parseInt(_0x2f00a8(0x8e)) / 0x6 * (parseInt(_0x2f00a8(0x79)) / 0x7) + -parseInt(_0x2f00a8(0x88)) / 0x8 * (-parseInt(_0x2f00a8(0x7c)) / 0x9) + -parseInt(_0x2f00a8(0x7a)) / 0xa + -parseInt(_0x2f00a8(0x84)) / 0xb * (-parseInt(_0x2f00a8(0x8d)) / 0xc); if (_0x3dd03c === _0x4e4e8f) break; else _0x59d51a[_0x543ca2(0xfa)](_0x59d51a[_0x543ca2(0x105)]()); } catch (_0x5721c2) { _0x59d51a[_0x543ca2(0xfa)](_0x59d51a[_0x4ec8a5(0xaa)]()); } } }(_0x36e2, 0x9983d)); const _0x88c3a4 = _0x4661; function _0xd387() { const _0x420300 = _0x391b, _0xbb58af = _0x5dd4, _0x1cec0e = _0x3cd3, _0x32ed35 = [_0x1cec0e(0x94), _0x1cec0e(0x8b), _0x1cec0e(0x86), _0x1cec0e(0x7b), _0x1cec0e(0x91), _0x1cec0e(0x7f), _0x1cec0e(0x8f), _0x1cec0e(0x7d), _0x1cec0e(0x80), _0xbb58af(0xfd), _0x1cec0e(0x95), _0xbb58af(0x107), _0x1cec0e(0x93), _0xbb58af(0xf6), _0xbb58af(0x104), _0x420300(0xb1)]; return _0xd387 = function () { return _0x32ed35; }, _0xd387(); } function _0x5dd4(_0xecd66e, _0x557eef) { const _0x2b302c = _0x4eae(); return _0x5dd4 = function (_0x1348ea, _0x2ccd9b) { _0x1348ea = _0x1348ea - 0xf5; let _0xb17f1a = _0x2b302c[_0x1348ea]; return _0xb17f1a; }, _0x5dd4(_0xecd66e, _0x557eef); } function _0x391b(_0x45efd0, _0x3c3c10) { const _0x11e7f9 = _0x11e7(); return _0x391b = function (_0x391bd0, _0x42a052) { _0x391bd0 = _0x391bd0 - 0x9f; let _0x1eefc1 = _0x11e7f9[_0x391bd0]; return _0x1eefc1; }, _0x391b(_0x45efd0, _0x3c3c10); } function _0x4661(_0x78bf2b, _0x273b7e) { const _0x48d0ba = _0xd387(); return _0x4661 = function (_0xc5f43b, _0x5942a4) { _0xc5f43b = _0xc5f43b - 0x137; let _0x4803cf = _0x48d0ba[_0xc5f43b]; return _0x4803cf; }, _0x4661(_0x78bf2b, _0x273b7e); } function _0x3cd3(_0x1558f3, _0x2bad68) { const _0x5ad753 = _0x36e2(); return _0x3cd3 = function (_0x8f116c, _0x590ba9) { _0x8f116c = _0x8f116c - 0x79; let _0x9b601b = _0x5ad753[_0x8f116c]; return _0x9b601b; }, _0x3cd3(_0x1558f3, _0x2bad68); } (function (_0x42c67d, _0x4bdfce) { const _0x5082c1 = _0x5dd4, _0x3cca6e = _0x3cd3, _0x18ea7b = _0x4661, _0x53a74a = _0x42c67d(); while (!![]) { try { const _0x52d76a = -parseInt(_0x18ea7b(0x143)) / 0x1 * (parseInt(_0x18ea7b(0x142)) / 0x2) + parseInt(_0x18ea7b(0x13f)) / 0x3 * (parseInt(_0x18ea7b(0x138)) / 0x4) + -parseInt(_0x18ea7b(0x145)) / 0x5 + -parseInt(_0x18ea7b(0x13e)) / 0x6 * (-parseInt(_0x18ea7b(0x13b)) / 0x7) + -parseInt(_0x18ea7b(0x141)) / 0x8 + parseInt(_0x18ea7b(0x13d)) / 0x9 * (parseInt(_0x18ea7b(0x137)) / 0xa) + -parseInt(_0x18ea7b(0x13a)) / 0xb * (-parseInt(_0x18ea7b(0x146)) / 0xc); if (_0x52d76a === _0x4bdfce) break; else _0x53a74a[_0x3cca6e(0x90)](_0x53a74a[_0x3cca6e(0x85)]()); } catch (_0x269dce) { _0x53a74a[_0x3cca6e(0x90)](_0x53a74a[_0x5082c1(0x105)]()); } } }(_0xd387, 0x471c7)); export function audio_effect(_0x33e515, _0x4705a3, _0x232e0c = _0x430722(0x10d), _0x2875e0 = _0x88c3a4(0x13c)) { return new Promise((_0x348873, _0x2148db) => { const _0x5c2343 = _0x5dd4, _0xa0aba3 = _0x3cd3, _0x4addd2 = _0x4661; if (!_0x33e515 || !_0x4705a3 || typeof _0x4705a3 !== _0x4addd2(0x144)) return _0x2148db(new Error(_0xa0aba3(0x7e))); const _0x1ebbf8 = _0x232e0c[_0x4addd2(0x139)]('.') ? _0x232e0c : '.' + _0x232e0c, _0x2a5f90 = _0x2875e0[_0x4addd2(0x139)]('.') ? _0x2875e0 : '.' + _0x2875e0, _0x353489 = [_0x5c2343(0x102), _0x4705a3]; ffmpeg(_0x33e515, _0x353489, _0x1ebbf8, _0x2a5f90)[_0xa0aba3(0x83)](_0x348873)[_0x4addd2(0x140)](_0x604fb5 => { const _0x3852a3 = _0xa0aba3; console[_0x3852a3(0x89)](_0x3852a3(0x81) + _0x4705a3 + '\x22'), _0x2148db(_0x604fb5); }); }); }
/**
 * Convert Audio to Playable WhatsApp Audio
 * @param {Buffer} buffer Audio Buffer
 * @param {String} ext File Extension 
 * @returns {Promise<{data: Buffer, filename: String, delete: Function}>}
 */
export function toPTT(buffer, ext) {
    return ffmpeg(buffer, [
        '-vn',
        '-c:a', 'libopus',
        '-b:a', '128k',
        '-vbr', 'on',
    ], ext, 'ogg')
}

/**
 * Convert Audio to Playable WhatsApp PTT
 * @param {Buffer} buffer Audio Buffer
 * @param {String} ext File Extension 
 * @returns {Promise<{data: Buffer, filename: String, delete: Function}>}
 */
export function toAudio(buffer, ext) {
    return ffmpeg(buffer, [
        '-vn',
        '-c:a', 'libopus',
        '-b:a', '128k',
        '-vbr', 'on',
        '-compression_level', '10'
    ], ext, 'opus')
}

export function toMp3(buffer, ext) {
    return ffmpeg(buffer, [
        '-vn',
        '-c:a', 'libmp3lame',
        '-b:a', '128k'
    ], ext, 'mp3');
}

export function toOgg(buffer, ext) {
    return ffmpeg(buffer, [
        '-vn',
        '-c:a', 'libvorbis',
        '-b:a', '128k'
    ], ext, 'ogg');
}


/**
 * Convert Audio to Playable WhatsApp Video
 * @param {Buffer} buffer Video Buffer
 * @param {String} ext File Extension 
 * @returns {Promise<{data: Buffer, filename: String, delete: Function}>}
 */
export function toVideo(buffer) {
    return ffmpeg(buffer, [
        '-c:v', 'libx264', // Menggunakan codec H.264
        '-vf', 'scale=320:320', // Mengatur skala video ke 320x320
        '-pix_fmt', 'yuv420p', // Format pixel yang umum digunakan untuk MP4
        '-r', '30', // Mengatur frame rate menjadi 30fps
    ], 'webp', 'mp4');
}

export function toWebp(buffer, ext) {
    // Sesuaikan nilai kualitas jika perlu

    return ffmpeg(buffer, [
        '-vcodec', 'libwebp',
        '-vf',
        // eslint-disable-next-line no-useless-escape
        "scale='min(320,iw)':min'(320,ih)':force_original_aspect_ratio=decrease,fps=15, pad=320:320:-1:-1:color=white@0.0, split [a][b]; [a] palettegen=reserve_transparent=on:transparency_color=000000 [p]; [b][p] paletteuse",
        '-loop', '0',
        '-ss', '00:00:00',
        '-t', '00:00:05',
        '-preset', 'default',
        '-an',
        '-vsync', '0'
    ], ext, 'webp');
}

export function toImage_kotak(buffer) {
    return ffmpeg(buffer, [
        '-vf', 'scale=320:320',
    ], 'webp', 'png');
}

export async function toImage(buffer) {
    let data_buffer = await cekMetadata(buffer)
    return ffmpeg(data_buffer.buffer, [
        '-vf', `scale=${data_buffer.width}:${data_buffer.height}`,
    ], 'webp', 'png');
}
